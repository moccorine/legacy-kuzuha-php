# ログデータ構造

## ログファイル形式

ログファイル（`bbs.log`）は、1行1投稿のCSV形式で保存されます。

## フィールド構造

各行は11個のフィールドで構成され、カンマ（`,`）で区切られます：

```
NDATE,POSTID,PCODE,THREAD,PHOST,AGENT,USER,MAIL,TITLE,MSG,REFID
```

### フィールド詳細

| インデックス | フィールド名 | 説明 | 例 |
|------------|------------|------|-----|
| 0 | NDATE | 投稿日時（Unixタイムスタンプ） | `1762582500` |
| 1 | POSTID | 投稿ID（連番） | `2` |
| 2 | PCODE | プロテクトコード（投稿認証用） | `SUT2` |
| 3 | THREAD | スレッドID | `2` |
| 4 | PHOST | 投稿者のホスト名/IPアドレス | `122-100-28-163m5.mineo.jp` |
| 5 | AGENT | User-Agent文字列 | `Mozilla/5.0 (Windows NT 10.0; ...)` |
| 6 | USER | ユーザー名 | `ユーザー` |
| 7 | MAIL | メールアドレス | `mail@example.com` |
| 8 | TITLE | 投稿タイトル | `タイトル` |
| 9 | MSG | 投稿内容 | `メッセージ内容\r\r<a href="...">...</a>` |
| 10 | REFID | 参照先投稿ID（返信の場合） | `1` |

## 特殊文字のエスケープ

### カンマのエスケープ

フィールド5-9（AGENT, USER, MAIL, TITLE, MSG）に含まれるカンマは、CSVの区切り文字と区別するため、HTMLエンティティ `&#44;` に変換されます。

**書き込み時:**
```php
str_replace(',', '&#44;', $value)
```

**読み込み時:**
```php
str_replace('&#44;', ',', $value)
```

### 改行コード

投稿内容（MSG）の改行は、`\r`（キャリッジリターン、`\015`）として保存されます。

- `\n`（ラインフィード）は削除されます
- 改行は `<br>` タグに変換**されません**（生の `\r` として保存）
- 表示時に `<pre>` タグ内で改行として表示されます

### NULL文字

互換性のため、NULL文字（`\0`）もカンマとして扱われる場合があります：

```php
strtr($value, "\0", ",")
```

## ログの例

```csv
1762582500,2,SUT2,2,122-100-28-163m5.mineo.jp,Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML&#44; like Gecko) Chrome/142.0.0.0 Safari/537.36,ユーザー,,タイトル,コンテンツ\r\r<a href="https://www.example.com" target="link">https://www.example.com</a>,
```

この例では：
- User-Agent内のカンマが `&#44;` にエスケープされています
- メールアドレスは空（2つのカンマが連続）
- 投稿内容に改行（`\r\r`）とリンクが含まれています
- REFIDは空（最後のカンマの後に値なし）

## 初期化ログ

空のログファイルを初期化する場合、以下の行を含めます：

```csv
0,0,0,0,0,0,0,0,0,0,0
```

## 関連ファイル

- **書き込み処理**: `src/Kuzuha/Bbs.php` - `putmessage()` メソッド
- **読み込み処理**: `src/Kuzuha/Webapp.php` - `getmessage()` メソッド
- **ログファイル**: `bbs.log`（メインログ）、`log/*.dat`（アーカイブログ）
